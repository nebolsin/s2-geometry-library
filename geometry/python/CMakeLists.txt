project(s2-python CXX)
cmake_minimum_required(VERSION 3.1.0 FATAL_ERROR)

add_definitions(-DS2_USE_EXACTFLOAT)
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# set(CMAKE_FIND_FRAMEWORK LAST)

find_package(SWIG REQUIRED)
find_package(PythonInterp 2.7 REQUIRED)

find_package(PkgConfig)
if(PKG_CONFIG_FOUND)
  pkg_search_module(PYTHON python-2.7 python)
endif()

if(NOT PYTHON_FOUND)
  find_package(PythonLibs 2.7 REQUIRED)
endif()

include_directories(${PYTHON_INCLUDE_DIRS})
link_directories(${PYTHON_LIBRARY_DIRS})

include(${SWIG_USE_FILE})

include_directories(${CMAKE_SOURCE_DIR})
include_directories(${CMAKE_CURRENT_SOURCE_DIR})

set_source_files_properties(s2.i PROPERTIES CPLUSPLUS ON)
swig_add_module(s2 python s2.i)
swig_link_libraries(s2 s2 s2cellid s2util ${PYTHON_LIBRARIES})

execute_process(
  COMMAND ${PYTHON_EXECUTABLE} -c "from distutils.sysconfig import get_python_lib; from os.path import join; print join(get_python_lib(), 's2')"
  OUTPUT_VARIABLE s2_python_install_dir
  OUTPUT_STRIP_TRAILING_WHITESPACE
)

# install _s2.so library
install(
  TARGETS ${SWIG_MODULE_s2_REAL_NAME}
  LIBRARY DESTINATION ${s2_python_install_dir}
  COMPONENT library
)

# install s2.py library loader generated by SWIG
install(
  FILES ${CMAKE_CURRENT_BINARY_DIR}/s2.py
  DESTINATION ${s2_python_install_dir}
  COMPONENT library
)

add_test(
  NAME s2python
  COMMAND "${PYTHON_EXECUTABLE}" "${CMAKE_CURRENT_SOURCE_DIR}/test.py"
)
